@inject WindowManager windowManager
@inject IJSRuntime JS

<div @onclick="OnClick" class="home-icon-outer">

    <img src='@iconUrl' class="icon" @onerror='OnIconError' style='@image_style' />

    <svg style='position: absolute; left: -10px; top: -10px' width='160px' height='160px' id="shape" xmlns="http://www.w3.org/2000/svg"
         xmlns:xlink="http://www.w3.org/1999/xlink">
        <defs>
            <path id="path"
                  fill="none" stroke="black" stroke-width="10"
                  d="
                    M 80, 80
                    m -60, 0
                    a 60,60 0 1,0 120,0
                    a 60,60 0 1,0 -120,0
                    "
                  transform="rotate(90 80 80)">
            </path>
        </defs>
        <text id="text-@Window.Id-@Planet.Id">
            <textPath xlink:href="#path" startOffset="50%" text-anchor="middle">
                <tspan class="title" fill='white' dy="0.3em">Loading...</tspan>
            </textPath>
        </text>
    </svg>
    @if (IsUnread)
    {
        <div class="unread">
        </div>
    }
</div>


@code {
    [Parameter]
    public Planet Planet { get; set; }

    [Parameter]
    public HomeWindow Window { get; set; }

    public string iconUrl = "/media/logo/logo-512.png";

    public string image_style = "";

    public bool IsUnread = false;

    protected override async Task OnInitializedAsync(){
        iconUrl = Planet.IconUrl;
        var channels = await Planet.GetChannelsAsync();
        foreach(var state in ValourClient.ChannelStates.Values)
        {
            var channel = channels.FirstOrDefault(x => x.Id == state.ChannelId);
            if (channel is not null)
            {
                IsUnread = DetermineUnread(channel);

                // no need to check the other channels if this one is unread
                if (IsUnread)
                {
                    return;
                }
            }
        }
    }

    public bool DetermineUnread(PlanetChatChannel chatChannel)
    {
        if (ValourClient.OpenPlanetChannels.Any(x => x.Id == chatChannel.Id))
            return false;

        if (!ValourClient.ChannelStates.ContainsKey(chatChannel.Id))
            return true;

        if (string.IsNullOrEmpty(chatChannel.State))
            return false;

        var channelStateTrim = chatChannel.State.Substring(13, chatChannel.State.Length - 13);
        long channelIndex = long.Parse(channelStateTrim);

        var localState = ValourClient.ChannelStates[chatChannel.Id].LastViewedState;
        long localIndex = -1;

        if (!string.IsNullOrEmpty(localState))
        {
            var localTrim = localState.Substring(13, localState.Length - 13);
            localIndex = long.Parse(localTrim);
        }

        return !(localIndex >= channelIndex);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await JS.InvokeVoidAsync($"SetCardTitle", $"{Window.Id}-{Planet.Id}", Planet.Name);
    }

    public async Task OnClick()
    {
        // Load planet first for personal reasons (let me keep the kids thanks)
        await ValourClient.OpenPlanet(Planet);
        await windowManager.SetFocusedPlanet(Planet);

        PlanetChatChannel channel = await Planet.GetPrimaryChannelAsync();

        Console.WriteLine($"Switching window {Window.Id} to {channel.Name}");

        var newWindow = new PlanetChatChannelWindow(channel);

        await windowManager.ReplaceWindow(Window, newWindow);
        await windowManager.SetSelectedWindow(newWindow);

        StateHasChanged();
    }

    protected void OnIconError()
    {
        iconUrl = "_content/Valour.Client/media/logo/logo-512.png";

        int r = Random.Shared.Next(24) * 15;

        image_style = $"filter: hue-rotate({r}deg)";

        StateHasChanged();
    }
}