@inject WindowManager windowManager
@inject IJSRuntime JS

<div @onclick="OnClick" class="home-icon-outer">

    <img src='@iconUrl' class="icon" @onerror='OnIconError' style='@image_style' />

    <svg style='position: absolute; left: -10px; top: -10px' width='160px' height='160px' id="shape" xmlns="http://www.w3.org/2000/svg"
         xmlns:xlink="http://www.w3.org/1999/xlink">
        <defs>
            <path id="path"
                  fill="none" stroke="black" stroke-width="10"
                  d="
                    M 80, 80
                    m -60, 0
                    a 60,60 0 1,0 120,0
                    a 60,60 0 1,0 -120,0
                    "
                  transform="rotate(90 80 80)">
            </path>
        </defs>
        <text id="text-discover-@Window.Id-@Planet.Id">
            <textPath xlink:href="#path" startOffset="50%" text-anchor="middle">
                <tspan class="title" fill='white' dy="0.3em">Loading...</tspan>
            </textPath>
        </text>
    </svg>
</div>

@code {
    [Parameter]
    public Planet Planet { get; set; }

    [Parameter]
    public HomeWindow Window { get; set; }

    [CascadingParameter]
    public IModalService Modal { get; set; }

    public string iconUrl = "/media/logo/logo-512.png";

    public string image_style = "";

    protected override async Task OnInitializedAsync(){
        iconUrl = Planet.IconUrl;
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await JS.InvokeVoidAsync($"SetCardTitle", $"discover-{Window.Id}-{Planet.Id}", Planet.Name);
    }

    public async Task OnClick()
    {
        // Attempt to join planet
        var result = await ValourClient.PrimaryNode.PostAsyncWithResponse<PlanetMember>($"api/planet/{Planet.Id}/discover");

        InfoModalData imodalData;

        if (!result.Success)
        {
            imodalData =
            new($"Failed to join.",
                "Reason: " + result.Message,
                "Okay",
                async () =>
                {
                    Console.WriteLine("User Clicked Ok");
                }
            );
        }
        else
        {
            imodalData =
            new($"Joined planet!",
                "Have a nice stay!",
                "Okay",
                async () =>
                {
                    Console.WriteLine("User Clicked Ok");
                }
            );

            ValourClient.JoinedPlanets.Add(Planet);
        }

        ModalParameters imodParams = new();
        imodParams.Add("Data", imodalData);

        Modal.Show<InfoModalComponent>("Info", imodParams, new ModalOptions() { Class = "modal-shrink-fit" });

        StateHasChanged();
    }

    protected void OnIconError()
    {
        iconUrl = "_content/Valour.Client/media/logo/logo-512.png";

        int r = Random.Shared.Next(24) * 15;

        image_style = $"filter: hue-rotate({r}deg)";

        StateHasChanged();
    }
}